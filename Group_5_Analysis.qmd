---
title: "Group 5 Analysis"
number-sections: true
format: 
  html:
    embed-resources: true
    code-tools: true
  pdf: default
editor_options: 
  chunk_output_type: console
---

```{r}
#| echo: false
#| warning: false
#| message: false

library(dplyr)
library(ggplot2)
library(tidyverse)
library(gt)
library(MASS)
library(patchwork)
library(gapminder)
library(janitor)
library(tidymodels)
library(moderndive)
library(ggstats)
library(sjPlot)
```

# Introduction {#sec-intro}

@sec-exp shows the exploratory analysis of Scottish Health Survey data, and explores how the prevalence of obesity in Scotland changes over years, and whether obesity prevalence differs by age, gender and employment factors. @sec-formal contains the results of the fitted logistic regression models of Scottish Health Survey data, and analysis for such models based on the questions of interest. Then, we make the overall conclusion in @sec-con.

```{r}
#| echo: false

Project11 <- read.csv("DAProject11.csv")

Project11 <- Project11 |>
  dplyr::mutate(ObesityStatus = ifelse(BMIgroup == "Obese", "Obesity", "Not Obesity"))

Project11$Year <- as.factor(Project11$Year)
Project11$Employment <- as.factor(Project11$Employment)
Project11$AgeGroup <- as.factor(Project11$AgeGroup)
Project11$Sex <- as.factor(Project11$Sex)
```

# Exploratory Analysis {#sec-exp}

We begin with creating a new binary response variable based on the BMIgroup variable for obesity classification, which is divided into "Obesity" and "Not Obesity". Then, we draw a barplot @fig-barYear to show how the prevalence of obesity in Scotland changes over years. Here we can see that both obesity and non-obesity barely changed between 2013 and 2016. The proportion of obesity was the highest in 2015 and the lowest in 2014, but the difference was not significant, with only a 0.4% fluctuation.

```{r}
#| echo: false
#| eval: false

Project11 |>
  tabyl(Year,ObesityStatus) |>
  adorn_percentages() |>
  adorn_pct_formatting() |>
  adorn_ns() |>
  gt()
```

```{r}
#| echo: false
#| label: fig-barYear
#| message: false
#| fig-cap: "Barplot of Obesity by Year"
#| fig-width: 4
#| fig-height: 3
#| fig-align: center

ggplot(data = Project11, aes(x = ObesityStatus, group = Year))+
  geom_bar(aes(y = after_stat(prop), fill = Year), stat = "count", position = "dodge") +
  labs(y = "Proportion", fill = "Year")
```

To further explore whether the prevalence of obesity differs by age, gender, and employment factors, we draw different barplots on obesity by age group, sex, and employment, respectively. @fig-barAge displays the proportion of obesity in different age groups. The 16-24 age group has the lowest obesity proportion, while the 65-74 age group has the highest proportion. We can see that the proportion of obesity gradually increases from the 16-24 age group to the 65-74 age group, but the obesity prevalence among the elderly over 75 years old group is lower than that in the previous age group.

```{r}
#| echo: false
#| label: fig-barAge
#| message: false
#| fig-cap: "Barplot of Obesity by AgeGroup"
#| fig-width: 4
#| fig-height: 3
#| fig-align: center

ggplot(data = Project11, aes(x = ObesityStatus, group = AgeGroup))+
  geom_bar(aes(y = after_stat(prop), fill = AgeGroup), stat = "count", position = "dodge") +
  labs(y = "Proportion", fill = "AgeGroup")
```

@fig-barSex illustrates the obesity proportion in females and males, respectively. There does not appear to be a significant difference in obesity rates between females and males, although the prevalence among females is slightly higher than that among males.

```{r}
#| echo: false
#| label: fig-barSex
#| message: false
#| fig-cap: "Barplot of Obesity by Sex"
#| fig-width: 4
#| fig-height: 3
#| fig-align: center

ggplot(data = Project11, aes(x = ObesityStatus, group = Sex))+
  geom_bar(aes(y = after_stat(prop), fill = Sex), stat = "count", position = "dodge") +
  labs(y = "Proportion", fill = "Sex")
```

@fig-barEmploy displays that people with full-time education have the lowest prevalence of obesity, while people who are permanently unable to work have the highest proportion. It seems likely that employment increases the prevalence of obesity, but a person is more likely to be obese if they are permanently unable to find a job.

```{r}
#| echo: false
#| label: fig-barEmploy
#| message: false
#| fig-cap: "Barplot of Obesity by Employment"
#| fig-width: 7
#| fig-height: 3
#| fig-align: center

ggplot(data = Project11, aes(x = ObesityStatus, group = Employment))+
  geom_bar(aes(y = after_stat(prop), fill = Employment), stat = "count", position = "dodge") +
  labs(y = "Proportion", fill = "Employment")
```

# Formal Analysis {#sec-formal}

We fit the logistic regression model for obesity prevalence from 2013 to 2016,

$$
\mbox{ln}(\frac{p_i}{1-p_i}) = \alpha + \beta_{\mbox{Year}} \cdot \mathbb{I}_{\mbox{Year}}(x)
$$

where

-   $p$ is the probability of obesity

-   $1-p$ is the probability of not obesity

-   $\alpha$ is the intercept of the regression line for the baseline Year (2013)

-   $\beta_{\mbox{Year}}$ the additional term added to $\alpha$ to get the intercept of the regression line for the specified Year

-   $\mathbb{I}_{\mbox{Year}}(x)$ is an indicator function indicating the chosen Year.

Hence, from @tbl-estimates we can see that the coefficient for $\alpha$ is -0.8330, and the coefficient $\beta_{\mbox{Year}}$ has different values, -0.0556, 0.0163, 0.0111 in year 2014, 2015, 2016, respectively. However, the p-value for all the $\beta_{\mbox{Year}}$ are larger than 0.05, then it can be concluded that there is not statistically significant at the 5% level.

```{r}
#| echo: false
#| tbl-cap: "Estimates of the intercept and slope from the fitted logistic regression model"
#| label: tbl-estimates

Project11 <- Project11 |>
  dplyr::mutate(ObesityStatus = ifelse(BMIgroup == "Obese", 1, 0))

model <- glm(ObesityStatus ~ Year, data = Project11,
                     family = binomial(link = "logit")) 
Coefs <- round(coef(model), 3)
tidy(model)[,c(1,2,3,5)] |>
  gt() |>
  fmt_number(decimals=4)
```

Also, we can plot the log-odds @fig-LogOdds for obesity by year to display 95% confidence interval graphically. The associated 95% confidence interval for thelog-odds includes 0 for each year, consequently the log-odds ratio is not statistically significant. Therefore, there is no evidence to show the prevalence of obesity in Scotland changed over the given years.

```{r}
#| echo: false
#| label: fig-LogOdds
#| message: false
#| fig-cap: "The log-odds for Obesity by Year"
#| fig-width: 4
#| fig-height: 2.5
#| fig-align: center

plot_model(model, show.values = TRUE, transform = NULL,
           title = "Log-Odds (Year)", show.p = FALSE)

```

Then we fit the logistic regression model for the explanatory variables, age group, sex, and employment,

$$
\mbox{ln}(\frac{p_i}{1-p_i}) = \alpha + \beta_{\mbox{AgeGroup}} \cdot \mathbb{I}_{\mbox{AgeGroup}}(x) + \beta_{\mbox{Sex}} \cdot \mathbb{I}_{\mbox{Sex}}(x) + \beta_{\mbox{Employment}} \cdot \mathbb{I}_{\mbox{Employment}}(x)
$$

where

-   $p$ is the probability of obesity

-   $1-p$ is the probability of not obesity

-   $\alpha$ is the intercept of the regression line for the baseline AgeGroup (16-24), Sex (Female), Employment (Doing something else)

-   $\beta_{\mbox{AgeGroup}}$ the additional term added to $\alpha$ to get the intercept of the regression line for the specified AgeGroup

-   $\beta_{\mbox{Sex}}$ the additional term added to $\alpha$ to get the intercept of the regression line for the specified Sex

-   $\beta_{\mbox{Employment}}$ the additional term added to $\alpha$ to get the intercept of the regression line for the specified Employment

-   $\mathbb{I}_{\mbox{AgeGroup}}(x)$ is an indicator function indicating the chosen AgeGroup.

-   $\mathbb{I}_{\mbox{Sex}}(x)$ is an indicator function indicating the chosen Sex.

-   $\mathbb{I}_{\mbox{Employment}}(x)$ is an indicator function indicating the chosen Employment.

```{r}
#| echo: false
#| tbl-cap: "Coefficients from the fitted logistic regression model with all explanatory variables"
#| label: tbl-coefficients

model <- glm(ObesityStatus ~ AgeGroup + Sex + Employment, data = Project11,
                     family = binomial(link = "logit")) 
Coefs <- round(coef(model), 3)
tidy(model)[,c(1,2,3,5)] |>
  gt() |>
  fmt_number(decimals=4)
```

```{r}
#| echo: false
#| label: fig-Odds
#| message: false
#| fig-cap: "Log-Odds for age group, sex, employment"
#| fig-width: 9
#| fig-height: 6
#| fig-align: center

plot_model(model, show.values = TRUE, transform = NULL,
           title = "", show.p = FALSE)
```

# Conclusion {#sec-con}
